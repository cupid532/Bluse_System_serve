#!/bin/bash
# 复制下面整段代码，粘贴到服务器终端执行

echo "=========================================="
echo "🧹 服务器完全清理脚本"
echo "=========================================="
echo ""
echo "⚠️  警告：此操作将："
echo "   - 停止并删除所有 Docker 容器"
echo "   - 删除所有 Docker 镜像和卷"
echo "   - 删除所有 Docker 网络"
echo "   - 清理 /data 目录下的所有数据"
echo ""
echo "按 Ctrl+C 取消，或等待 5 秒后自动开始..."
sleep 5

echo ""
echo "开始清理..."

# 1. 停止所有容器
echo ""
echo "📦 [1/7] 停止所有运行中的容器..."
docker stop $(docker ps -q) 2>/dev/null && echo "   ✓ 已停止容器" || echo "   ✓ 无运行中的容器"

# 2. 删除所有容器
echo ""
echo "🗑️  [2/7] 删除所有容器..."
docker rm -f $(docker ps -aq) 2>/dev/null && echo "   ✓ 已删除所有容器" || echo "   ✓ 无容器需要删除"

# 3. 删除所有镜像
echo ""
echo "🖼️  [3/7] 删除所有 Docker 镜像..."
docker rmi -f $(docker images -q) 2>/dev/null && echo "   ✓ 已删除所有镜像" || echo "   ✓ 无镜像需要删除"

# 4. 删除所有卷
echo ""
echo "💾 [4/7] 删除所有 Docker 卷..."
docker volume rm $(docker volume ls -q) 2>/dev/null && echo "   ✓ 已删除所有卷" || echo "   ✓ 无卷需要删除"

# 5. 删除所有自定义网络
echo ""
echo "🌐 [5/7] 删除所有自定义网络..."
docker network prune -f && echo "   ✓ 已删除自定义网络"

# 6. 清理 Docker 系统缓存
echo ""
echo "🧽 [6/7] 清理 Docker 系统缓存..."
docker system prune -a -f --volumes && echo "   ✓ 已清理系统缓存"

# 7. 清理 /data 目录
echo ""
echo "🗂️  [7/7] 清理 /data 目录..."
if [ -d "/data" ]; then
    rm -rf /data/* 2>/dev/null && echo "   ✓ 已清空 /data 目录" || echo "   ⚠️  /data 清理时遇到部分错误"
else
    echo "   ✓ /data 目录不存在"
fi

# 清理 cron 任务
echo ""
echo "⏰ [额外] 清理 cron 定时任务..."
crontab -r 2>/dev/null && echo "   ✓ 已清理 cron 任务" || echo "   ✓ 无 cron 任务"

# 最终报告
echo ""
echo "=========================================="
echo "✅ 清理完成！"
echo "=========================================="
echo ""
echo "📊 当前状态："
echo "   - Docker 容器: $(docker ps -a 2>/dev/null | wc -l) 个 (含表头)"
echo "   - Docker 镜像: $(docker images 2>/dev/null | wc -l) 个 (含表头)"
echo "   - Docker 卷: $(docker volume ls 2>/dev/null | wc -l) 个 (含表头)"
echo ""
echo "💿 磁盘空间："
df -h / | tail -1 | awk '{print "   - 系统盘: "$3" 已用 / "$2" 总计 ("$5" 使用率)"}'
echo ""
echo "📝 后续操作："
echo "   1. 重新执行初始化脚本"
echo "   2. 部署核心服务"
echo ""
echo "=========================================="
