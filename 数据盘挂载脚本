#!/bin/bash

# 显示未挂载的磁盘
echo "未挂载的磁盘列表："
lsblk -o NAME,SIZE,TYPE,MOUNTPOINT | grep disk

# 选择磁盘
read -p "请输入要挂载的磁盘（例如 sdb）: " DISK_NAME
DISK="/dev/$DISK_NAME"

if [ ! -b "$DISK" ]; then
    echo "❌ 磁盘 $DISK 不存在"
    exit 1
fi

# 选择挂载点
read -p "请输入挂载点（例如 /data 或 /home）: " MOUNT_POINT

# 检查挂载点是否存在
if [ -d "$MOUNT_POINT" ]; then
    echo "⚠️  目录 $MOUNT_POINT 已存在"
    ls -la "$MOUNT_POINT"
    read -p "是否清空该目录？(y/n): " clear_dir
    if [ "$clear_dir" = "y" ]; then
        read -p "⚠️  确认删除 $MOUNT_POINT 中的所有内容？(yes/n): " confirm_clear
        if [ "$confirm_clear" = "yes" ]; then
            rm -rf "$MOUNT_POINT"/*
            echo "✅ 目录已清空"
        else
            echo "❌ 已取消清空"
            exit 1
        fi
    fi
else
    read -p "目录 $MOUNT_POINT 不存在，是否创建？(y/n): " create_dir
    if [ "$create_dir" = "y" ]; then
        mkdir -p "$MOUNT_POINT"
        echo "✅ 目录已创建"
    else
        echo "❌ 已取消"
        exit 1
    fi
fi

# 确认格式化
echo ""
echo "即将格式化: $DISK"
echo "挂载到: $MOUNT_POINT"
read -p "确认格式化？(yes/n): " confirm_format

if [ "$confirm_format" = "yes" ]; then
    mkfs.ext4 -F "$DISK"
    mount "$DISK" "$MOUNT_POINT"
    UUID=$(blkid -s UUID -o value "$DISK")
    
    # 检查 fstab 是否已有该挂载点
    if grep -q "$MOUNT_POINT" /etc/fstab; then
        echo "⚠️  /etc/fstab 中已存在 $MOUNT_POINT 的配置"
        read -p "是否替换？(y/n): " replace_fstab
        if [ "$replace_fstab" = "y" ]; then
            sed -i "\|$MOUNT_POINT|d" /etc/fstab
        fi
    fi
    
    echo "UUID=$UUID $MOUNT_POINT ext4 defaults,nofail 0 2" >> /etc/fstab
    echo "✅ 挂载完成！"
    df -h "$MOUNT_POINT"
else
    echo "❌ 已取消"
fi
